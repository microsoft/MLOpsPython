# Pipeline template that creates a model package and adds the package location to the environment for subsequent tasks to use.
parameters:
- name: modelId
  type: string
  default: ''
- name: workingDirectory # The working directory to run the CLI script
  type: string
  default: ''
- name: inferenceConfigPath # The references in inference config should be relative to the working directory
  type: string
  default: ''
- name: entryScriptPath # Optional - will overwrite inference config entry script
  type: string
  default: ''

steps:
  - task: AzureCLI@1
    displayName: 'Install AzureML CLI'
    inputs:
      azureSubscription: '$(WORKSPACE_SVC_CONNECTION)'
      scriptLocation: inlineScript
      workingDirectory: $(Build.SourcesDirectory)
      inlineScript: 'az extension add -n azure-cli-ml'

  # Default - build using inference config only
  - ${{ if eq(parameters.entryScriptPath, '') }}:
    - task: AzureCLI@1
      displayName: 'Create model package and set IMAGE_LOCATION variable'
      inputs:
        azureSubscription: ${{ parameters.workingDirectory }}
        scriptLocation: inlineScript
        inlineScript: |
          set -e # fail on error

          # Create model package using CLI
          az ml model package --workspace-name $(WORKSPACE_NAME) -g $(RESOURCE_GROUP) \
          --model '${{ parameters.modelId }}' \
          --ic '${{ parameters.inferenceConfigPath }}' \
          -v \
          --rt python --query 'location' -o tsv > image_logs.txt

  # Option to overwrite entry script
  - ${{ if ne(parameters.entryScriptPath, '') }}:
    - task: AzureCLI@1
      displayName: 'Create model package and set IMAGE_LOCATION variable'
      inputs:
        azureSubscription: ${{ parameters.workingDirectory }}
        scriptLocation: inlineScript
        inlineScript: |
          set -e # fail on error

          # Create model package using CLI
          az ml model package --workspace-name $(WORKSPACE_NAME) -g $(RESOURCE_GROUP) \
          --model '${{ parameters.modelId }}' \
          --ic '${{ parameters.inferenceConfigPath }}' \
          --entry-script '${{ parameters.entryScriptPath }}'
          -v \
          --rt python --query 'location' -o tsv > image_logs.txt

  - task: AzureCLI@1
    displayName: 'Create model package and set IMAGE_LOCATION variable'
    inputs:
      azureSubscription: ${{ parameters.workingDirectory }}
      scriptLocation: inlineScript
      inlineScript: |
        set -e # fail on error

        # Show logs
        cat image_logs.txt

        # Set environment variable using the last line of logs that has the package location
        IMAGE_LOCATION=$(tail -n 1 image_logs.txt)
        echo "##vso[task.setvariable variable=IMAGE_LOCATION]$IMAGE_LOCATION"
